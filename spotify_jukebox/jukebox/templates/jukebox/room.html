{% extends 'jukebox/base.html' %}

{% block content %}
<style>
    /* --- –°–¢–ò–õ–ò –í–ò–ù–ò–õ–ê –ò –ò–ù–¢–ï–†–§–ï–ô–°–ê --- */
    .glass-panel {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
    }

    .vinyl-container {
        position: relative;
        display: inline-block;
        width: 200px;
        height: 200px;
    }

    .vinyl-disk {
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, #222 30%, #050505 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        z-index: 1;
    }

    .vinyl-cover {
        width: 85px;
        height: 85px;
        border-radius: 50%;
        object-fit: cover;
        z-index: 2;
        border: 3px solid #111;
        animation: spin 4s linear infinite;
        animation-play-state: paused;
    }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .is-playing-state .vinyl-cover { animation-play-state: running; }
    .is-playing-state .tonearm-visual { transform: rotate(-12deg); }

    .tonearm-visual {
        position: absolute;
        top: 0;
        right: 10px;
        width: 8px;
        height: 90px;
        background: linear-gradient(to bottom, #999, #444);
        border-radius: 4px;
        transform-origin: top center;
        transform: rotate(-40deg);
        transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10;
    }

    #actual-progress-bar {
        height: 100%;
        background-color: #1DB954;
        width: 0%;
        transition: width 2.1s linear;
    }

    .control-btn { transition: all 0.2s; }
    .control-btn:hover { transform: scale(1.1); color: #1DB954 !important; }

    /* --- –°–¢–ò–õ–ò –î–õ–Ø –ì–û–õ–û–°–û–í–û–ì–û –ê–°–°–ò–°–¢–ï–ù–¢–ê --- */
    .pulse-animation {
        animation: pulse-red 1.5s infinite;
    }
    @keyframes pulse-red {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
        70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }
</style>

<div class="row justify-content-center mt-4" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    <div class="col-md-6 col-lg-5 text-center">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-danger btn-sm" hx-post="/leave-room/">
                <i class="bi bi-box-arrow-left"></i> Leave
            </button>

            <div class="text-center">
                <span class="text-secondary text-uppercase small ls-1">Room Code</span>
                <div class="d-flex align-items-center justify-content-center gap-2">
                    <h2 class="h4 fw-bold mb-0 text-white">{{ room.code }}</h2>
                    <button id="voice-btn" class="btn btn-outline-warning btn-sm rounded-circle shadow-sm"
                            style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;"
                            title="–ì–æ–ª–æ—Å–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
                        <i class="bi bi-mic-fill" style="font-size: 0.9rem;"></i>
                    </button>
                </div>
            </div>

            {% if is_host %}
            <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#settingsModal"
                    hx-get="/api/get-room/?code={{ room.code }}" hx-target="#settings-form-content">
                <i class="bi bi-gear-fill"></i>
            </button>
            {% else %}
            <div style="width: 45px;"></div>
            {% endif %}
        </div>

        <div id="spotify-status" class="alert alert-warning text-center mb-4" style="display:none;"></div>

        <div class="glass-panel p-4 mb-3">
            <div id="main-vinyl-container" class="vinyl-container mb-4">
                <div class="vinyl-disk">
                    <img id="dynamic-vinyl-cover" src="" class="vinyl-cover" style="display:none;">
                    <div id="vinyl-placeholder" class="bg-dark rounded-circle" style="width:85px; height:85px; border:3px solid #111;"></div>
                </div>
                <div class="tonearm-visual"></div>
            </div>

            <div class="progress-section mb-4 px-3">
                <div class="d-flex justify-content-between text-secondary mb-1" style="font-size: 0.7rem;">
                    <span id="js-display-time">0:00</span>
                    <span id="js-display-duration">0:00</span>
                </div>
                <div class="progress bg-dark" style="height: 4px; overflow: hidden; border-radius: 2px;">
                    <div id="actual-progress-bar"></div>
                </div>
            </div>

            <div id="music-player"
                 hx-get="/api/current-song/"
                 hx-trigger="load, every 2s"
                 hx-swap="innerHTML"
                 hx-on::after-request="syncVinylState()">
                <div class="text-secondary p-5">Loading player‚Ä¶</div>
            </div>

            <button id="pills-queue-tab" class="btn btn-outline-light btn-sm w-100 mt-3" data-bs-toggle="modal" data-bs-target="#queueModal"
                    hx-get="/api/queue/" hx-target="#queue-content">
                <i class="bi bi-music-note-list"></i> Open Queue
            </button>
        </div>

        <div class="search-section text-start mt-4">
            <h4 class="text-white mb-3 h5">Add Song to Queue</h4>
            <div class="input-group mb-3">
                <span class="input-group-text bg-dark border-secondary text-secondary"><i class="bi bi-search"></i></span>
                <input type="text" name="query" class="form-control bg-dark text-white border-secondary"
                       placeholder="Search tracks..." hx-get="/api/spotify/search/" hx-trigger="keyup changed delay:500ms"
                       hx-target="#search-results" autocomplete="off">
            </div>
            <div id="search-results" style="max-height: 350px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="queueModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Queue</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div id="queue-content" class="modal-body"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Room Settings</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div id="settings-form-content"></div>
                </form>
            </div>
            <div class="modal-footer border-secondary">
                <button class="btn btn-primary btn-sm" hx-patch="/update-room/" hx-include="#settings-form"
                        hx-vals='{"code": "{{ room.code }}"}' data-bs-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –í–ò–ù–ò–õ–ê (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è HTMX) ---
    function syncVinylState() {
        const dataTag = document.getElementById('player-data');
        if (!dataTag) return;

        const isPlaying = dataTag.getAttribute('data-playing') === 'true';
        const newImg = dataTag.getAttribute('data-image');
        const progress = dataTag.getAttribute('data-progress');
        const timeStr = dataTag.getAttribute('data-time');
        const durationStr = dataTag.getAttribute('data-duration');

        const container = document.getElementById('main-vinyl-container');
        const cover = document.getElementById('dynamic-vinyl-cover');
        const progressBar = document.getElementById('actual-progress-bar');

        if (isPlaying) container.classList.add('is-playing-state');
        else container.classList.remove('is-playing-state');

        if (progressBar) {
            if (isPlaying) {
                progressBar.style.transition = "width 2.1s linear";
                progressBar.style.width = progress + "%";
            } else {
                progressBar.style.transition = "none";
                progressBar.style.width = progress + "%";
            }
        }

        document.getElementById('js-display-time').innerText = timeStr;
        document.getElementById('js-display-duration').innerText = durationStr;

        if (newImg && cover.src !== newImg) {
            cover.src = newImg;
            cover.style.display = 'block';
            document.getElementById('vinyl-placeholder').style.display = 'none';
        }
    }

    // --- 2. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (CSRF) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï ---
    document.addEventListener("DOMContentLoaded", function () {

        // A. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Spotify
        fetch("/api/is-authenticated/")
            .then(res => res.json())
            .then(data => {
                if (!data.status) {
                    document.getElementById("spotify-status").style.display = "block";
                    {% if not is_host %}
                    document.getElementById("spotify-status").innerHTML = '<p class="mb-0">Waiting for host to connect...</p>';
                    {% endif %}
                }
            });

        // B. –õ–æ–≥–∏–∫–∞ –ì–æ–ª–æ—Å–æ–≤–æ–≥–æ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const voiceBtn = document.getElementById('voice-btn');

        if (!SpeechRecognition) {
            console.warn("Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.");
            if(voiceBtn) voiceBtn.style.display = 'none'; // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ —É–º–µ–µ—Ç —Å–ª—É—à–∞—Ç—å
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'ru-RU'; // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
        recognition.continuous = false;
        recognition.interimResults = false;

        // –ö–ª–∏–∫ –ø–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
        voiceBtn.onclick = () => {
            try {
                recognition.start();
            } catch (e) {
                console.error("–£–∂–µ –∑–∞–ø—É—â–µ–Ω–æ", e);
            }
        };

        recognition.onstart = () => {
            console.log("üé§ –°–ª—É—à–∞—é...");
            voiceBtn.classList.remove('btn-outline-warning');
            voiceBtn.classList.add('btn-danger', 'pulse-animation');
        };

        recognition.onend = () => {
            console.log("üé§ –ö–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏.");
            voiceBtn.classList.remove('btn-danger', 'pulse-animation');
            voiceBtn.classList.add('btn-outline-warning');
        };

        recognition.onerror = (event) => {
            console.error("–û—à–∏–±–∫–∞ Speech API:", event.error);
            // alert("–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: " + event.error); // –ú–æ–∂–Ω–æ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            voiceBtn.classList.remove('btn-danger', 'pulse-animation');
            voiceBtn.classList.add('btn-outline-warning');
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Ä–µ—á–∏
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript.toLowerCase().trim();
            console.log("–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ:", transcript);

            if (transcript.includes('–ø–ª–µ–π') || transcript.includes('–∏–≥—Ä–∞–π') || transcript.includes('–≤–∫–ª—é—á–∏')) {
                apiCall('/api/play-song/', 'PUT');
            }
            else if (transcript.includes('–ø–∞—É–∑–∞') || transcript.includes('—Å—Ç–æ–ø') || transcript.includes('—Ç–∏—Ö–æ')) {
                apiCall('/api/pause-song/', 'PUT');
            }
            else if (transcript.includes('—Å–ª–µ–¥—É—é—â–∏–π') || transcript.includes('–¥–∞–ª—å—à–µ') || transcript.includes('—Å–∫–∏–ø')) {
                apiCall('/api/skip-song/', 'POST');
            }
            else if (transcript.includes('–≤—ã–π—Ç–∏')) {
                const leaveBtn = document.querySelector('button[hx-post="/leave-room/"]');
                if(leaveBtn) leaveBtn.click();
            }
            else if (transcript.includes('–æ—á–µ—Ä–µ–¥—å')) {
                const queueTab = document.getElementById('pills-queue-tab');
                if(queueTab) queueTab.click();
            }
            else if (transcript.startsWith('–¥–æ–±–∞–≤—å') || transcript.startsWith('–ø–æ—Å—Ç–∞–≤—å')) {
                const songName = transcript.replace(/^(–¥–æ–±–∞–≤—å|–ø–æ—Å—Ç–∞–≤—å)\s*/, '');
                if (songName.length > 1) {
                    searchAndAdd(songName);
                } else {
                    alert('–ù–µ –ø–æ–Ω—è–ª –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏.');
                }
            }
            else {
                // –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞, –º–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –∞–ª–µ—Ä—Ç –∏–ª–∏ –ø—Ä–æ–º–æ–ª—á–∞—Ç—å
                console.log(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: "${transcript}"`);
            }
        };

        // –§—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–∞ API
        function apiCall(url, method) {
            const csrftoken = getCookie('csrftoken');
            fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            }).then(res => {
                console.log(`API ${url} status:`, res.status);
            });
        }

        // –õ–æ–≥–∏–∫–∞ "–î–æ–±–∞–≤—å –ø–µ—Å–Ω—é"
        function searchAndAdd(query) {
            console.log(`–ò—â—É: ${query}`);
            fetch(`/api/spotify/search/?query=${encodeURIComponent(query)}`)
                .then(res => res.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    // –ò—â–µ–º –ø–µ—Ä–≤—É—é –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞
                    const btn = doc.querySelector('button[hx-vals]');

                    if (btn) {
                        const data = JSON.parse(btn.getAttribute('hx-vals'));
                        const csrftoken = getCookie('csrftoken');
                        const formData = new FormData();
                        formData.append('uri', data.uri);
                        formData.append('title', data.title);
                        formData.append('artist', data.artist);
                        formData.append('image_url', data.image_url);

                        fetch('/api/add-to-queue/', {
                            method: 'POST',
                            headers: { 'X-CSRFToken': csrftoken },
                            body: formData
                        }).then(res => {
                            if(res.ok) {
                                alert(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ${data.title}`);
                                // –ú–æ–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –æ—á–µ—Ä–µ–¥—å, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                                // document.getElementById('pills-queue-tab').click();
                            }
                        });
                    } else {
                        alert(`–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–µ–ª –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}" üòî`);
                    }
                });
        }
    });
</script>
{% endblock %}