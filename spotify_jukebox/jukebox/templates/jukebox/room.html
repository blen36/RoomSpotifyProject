<div class="mb-3">
    <img src="{{ song.image_url }}" 
         alt="Album Art" 
         class="rounded album-art" 
         style="width: 100%; max-width: 280px; aspect-ratio: 1/1; object-fit: cover;">
</div>

<div class="mb-4">
    <h3 class="fw-bold text-white mb-1">{{ song.title }}</h3>
    <p class="text-secondary mb-0">{{ song.artist }}</p>
</div>

<div class="progress-container mb-4 px-2">
    <div class="progress bg-secondary bg-opacity-25" style="height: 6px; border-radius: 3px; overflow: hidden;">
        <div id="progress" 
             class="progress-bar bg-success" 
             role="progressbar" 
             style="width: 0%; transition: width 0.1s linear;">
        </div>
    </div>
    <div class="d-flex justify-content-between mt-1">
        <span class="small text-secondary" id="curr-time">0:00</span>
        <span class="small text-secondary">{{ song.duration_fmt }}</span>
    </div>
</div>

<div class="d-flex justify-content-center align-items-center gap-4">
    
    {% if song.is_playing %}
        <button class="btn btn-circle btn-lg btn-success hover-scale shadow-lg"
                hx-put="/api/pause"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-swap="none">
            <i class="fas fa-pause text-black"></i>
        </button>
    {% else %}
        <button class="btn btn-circle btn-lg btn-white hover-scale shadow-lg"
                hx-put="/api/play"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-swap="none">
            <i class="fas fa-play text-black ml-1"></i>
        </button>
    {% endif %}

    <button class="btn btn-circle btn-secondary hover-scale"
            hx-post="/api/skip"
            hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
        <i class="fas fa-step-forward text-white"></i>
    </button>
</div>

<script>
    // Сбрасываем старый интервал при обновлении HTMX
    if (window.progressInterval) clearInterval(window.progressInterval);

    var duration = {{ song.duration }};  // Всего мсек
    var progress = {{ song.time }};      // Текущее мсек
    var isPlaying = {{ song.is_playing|yesno:"true,false" }};

    function updateBar() {
        var percent = (progress / duration) * 100;
        if (percent > 100) percent = 100;
        
        // Обновляем ширину
        var bar = document.getElementById('progress');
        if (bar) bar.style.width = percent + '%';
        
        // Обновляем текст времени (0:00)
        var timeLabel = document.getElementById('curr-time');
        if (timeLabel) {
            var totalSec = Math.floor(progress / 1000);
            var min = Math.floor(totalSec / 60);
            var sec = totalSec % 60;
            timeLabel.innerText = min + ':' + (sec < 10 ? '0' : '') + sec;
        }
    }

    // Первый запуск
    updateBar();

    // Если музыка играет, запускаем плавный таймер
    if (isPlaying) {
        window.progressInterval = setInterval(function() {
            progress += 100; // Добавляем 100мс
            if (progress > duration) progress = duration;
            updateBar();
        }, 100);
    }
</script>